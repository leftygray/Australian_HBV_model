---
title: "Australia HBV Model Summary Results"
author: "Richard T. Gray"
date: Latest version - `r format(Sys.Date(), format="%B %d %Y")`
output: 
  word_document:
    pandoc_args: --output="docs/Summary_results.docx"
    reference_docx: docs/mystyles.docx
---

<!---This Rmarkdown scipt generates the summary figures and outputs from
the results generated using the ECDC HIV Modelling Tool. --->

```{r knitr_options, include=FALSE} 
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      include = FALSE) 
```

This document presents the summary results for the baseline scenario in
the Australian HBV model. 

```{r Initialize script}
# Clear workspace and plots
rm(list = ls()) 
graphics.off()

# Setup directories after setting working directory to source file 
# directory (so it is easy to move code around)
basePath <- getwd()
Rcode <- file.path(basePath, "code")
projectFolder <- file.path(basePath, "projects")

# Load useful libraries
source(file.path(Rcode, "LoadLibrary.R"))
source(file.path(Rcode, "DataLibraries.R"))
source(file.path(Rcode, "PlotOptions.R"))
source(file.path(Rcode, "PlotFunctions.R"))
LoadLibrary(cowplot)

# Wrapper function so we don't have to keep entering everything in
# ggsave. Plot defaults are put in the figure defaults
SaveFigure <- function(folder, filename, figure, 
                       format = ".png", height = 10, 
                       units = "cm", ...) {
  save_plot(file.path(folder, paste0(filename, format)), 
         figure, 
         base_height = height, units = units, ...)
}

```

```{r User sepcifications}
# Specify project to run
project <- "Australia_HBV_estimates-BM"

# Plotting options
displayPlots <- TRUE
savePlots <- FALSE

startYear <- 2000
endYear <- 2030

```

```{r Load project results}
# This loads all the project parameters and results including 
# bestResults

projectFile <- file.path(projectFolder, project, paste0(project, ".rda"))
load(projectFile)
```

```{r Generate plots}

# Population sizes ------------------------------------------------------

# First convert results population sizes into a massize data frame
popSizes <- as.data.frame.table(bestResults$allPops)
colnames(popSizes) <- c("age_group", "state", "time_step", "popsize") 
popSizes$time_step <- as.numeric(popSizes$time_step)

popSizes <- popSizes %>% # add pts as well
  mutate(year = pg$start_year + (time_step - 1) * pg$timestep) 
# 
totalPop <- popSizes %>%
  group_by(year) %>%
  summarise(totalpop = sum(popsize)) 

totalPopPlot <- ggplot(data = totalPop, aes(x = year, y = totalpop)) +
  geom_line(colour = "blue") +
  xlab("Year") + ylab("Population size") +
  coord_cartesian(xlim = c(startYear, endYear)) +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  plotOpts

popSizesAge <- popSizes %>%
  group_by(year, age_group) %>%
  summarise(totalpop = sum(popsize)) %>%
  ungroup() %>%
  arrange(age_group)

# Plot of population size in every group - first rename levels for
# plotting
plotAgePops <- popSizesAge
plotAgePops$age_group <- factor(plotAgePops$age_group)

levels(plotAgePops$age_group) <- c("Age < 4", "Age 5 to 14", 
                                   "Age 15 to 44", "Age > 45") 

agePopPlot <- ggplot(data = plotAgePops, 
                     aes(x = year, y = totalpop, group = age_group)) +
  geom_line(colour = "blue") +
  facet_wrap(~age_group, ncol = 2, scales = "free_x") + 
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  xlab("Year") + ylab("Population size") +
  plotOpts + theme(panel.margin = unit(2, "lines"))

# Population prevalence --------------------------------------------------

# Data frame for overall number of people infected by age 
numInfected <-  popSizes %>%
  group_by(year, age_group) %>%
  filter(state %in% c("a", "ch")) %>% 
  summarise(numinfected = sum(popsize)) %>%
  ungroup() %>%
  arrange(age_group) %>%
  mutate(popsize = popSizesAge$totalpop,
    prevalence = numinfected / popSizesAge$totalpop)

# Plot of total number of people infected and overall prevalence
totalPrev <- numInfected %>%
  group_by(year) %>%
  summarise(total_infected = sum(numinfected)) %>%
  mutate(overall_prev = total_infected / totalPop$totalpop)
             
totalInfectedPlot <- ggplot(data = totalPrev, 
                        aes(x = year, y = total_infected)) +
  geom_line(colour = "blue") +
  xlab("Year") + ylab("Total number infected") +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  plotOpts

totalPrevPlot <- ggplot(data = totalPrev, 
                        aes(x = year, y = overall_prev)) +
  geom_line(colour = "blue") +
  xlab("Year") + ylab("Overall prevalence") +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  plotOpts

# Plot of prevalence in every group - first sort out level names for
# plotting
plotPrevPops <- numInfected
plotPrevPops$age_group <- factor(numInfected$age_group)
levels(plotPrevPops$age_group) <- c("Age < 4", "Age 5 to 14", 
                                   "Age 15 to 44", "Age > 45") 

popInfectedPlot <- ggplot(data = plotPrevPops, 
                     aes(x = year, y = numinfected, group = age_group)) +
  geom_line(colour = "blue") +
  facet_wrap(~age_group, ncol = 2, scales = "free_x") + 
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  xlab("Year") + ylab("Population size") +
  plotOpts + theme(panel.margin = unit(2, "lines"))

popPrevPlot <- ggplot(data = plotPrevPops, 
                     aes(x = year, y = prevalence, group = age_group)) +
  geom_line(colour = "blue") +
  facet_wrap(~age_group, ncol = 2, scales = "free_x") + 
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  xlab("Year") + ylab("Population prevalence") +
  plotOpts + theme(panel.margin = unit(2, "lines"))

# Plot of population size in every group- first sort out level names for
# plotting. Essentially prevalence by age and state
plotPops <- popSizes
plotPops$age_group <- factor(plotPops$age_group)
levels(plotPops$age_group) <- c("Age < 4", "Age 5 to 14", "Age 15 to 44",
                                "Age > 45")

allPopsPlot <- ggplot(data = plotPops, 
                      aes(x = year, y = popsize, group = state)) +
  facet_wrap(~age_group, ncol = 2, scales = "free_x") +
  geom_line(aes(colour = state)) +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  scale_colour_brewer(name = "Infection state", palette = "Set1",
                      labels = c("Susceptible", "Acute", "Chronic",
                                 "Cleared", "Immune")) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  xlab("Year") + ylab("Population size") +
  plotOpts + theme(legend.position = "right") + 
  theme(panel.margin = unit(2, "lines"))

# New infections and incidence -------------------------------------------

newInfections <- as.data.frame(t(bestResults$newInfections)) %>%
  mutate(year = pg$pts) %>%
  select(year, everything()) %>%
  gather("age_group", "infections", 2:(pg$npops+1)) %>%
  mutate(incidence = infections / popSizesAge$totalpop,
         total_pop = popSizesAge$totalpop)

annNewInfections <- yearDf(newInfections, "infections", pg$years,
                           pg$npops, pg$timestep, midVar = "total_pop",
                           divideVar = "incidence")

# Total new infections
totalInfections <- newInfections %>%
  group_by(year) %>%
  summarise(new_infects = sum(infections),
            total_pop = sum(total_pop)) %>%
  mutate(incidence = new_infects / total_pop) 

annTotalInfections <- yearDf(totalInfections, "new_infects", pg$years,
                             1, pg$timestep, midVar = "total_pop",
                             divideVar = "incidence")

# Create total plots
totalNewInfectionsPlot <- ggplot(data = annTotalInfections, 
    aes(x = year, y = new_infects)) +
  geom_line(colour = "blue") +
  xlab("Year") + ylab("New Infections") +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  plotOpts

totalIncidencePlot <- ggplot(data = annTotalInfections, 
    aes(x = year, y = incidence * 1e5)) +
  geom_line(colour = "blue") +
  xlab("Year") + ylab("Incidence per 100,000") +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  plotOpts

# By age group
popNewInfectionsPlot <- ggplot(data = annNewInfections, 
    aes(x = year, y = infections, group= age_group)) +
  geom_line(aes(color = age_group)) + 
  xlab("Year") + ylab("New infections") +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  scale_colour_brewer(name = "Age Group", palette = "Set1",
                      labels = c("Age < 4", "Age 5 to 14", "Age 15 to 44",
                                "Age > 45")) + 
  coord_cartesian(xlim = c(startYear, endYear)) +
  plotOpts + theme(legend.position = "right")

popIncidencePlot <- ggplot(data = annNewInfections, 
  aes(x = year, y = incidence * 1e5, group = age_group)) + 
  geom_line(aes(color = age_group)) + 
  xlab("Year") + ylab("Incidence per 100,000") +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  scale_colour_brewer(name = "Age Group", palette = "Set1",
                      labels = c("Age < 4", "Age 5 to 14", "Age 15 to 44",
                                "Age > 45")) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  plotOpts + theme(legend.position = "right")
  
# Treatment --------------------------------------------------------------
popTreatments <- as.data.frame(t(bestResults$newTreatments)) %>%
  mutate(year = pg$pts) %>%
  select(year, everything()) %>%
  gather("age_group", "treatments", 2:(pg$npops+1)) 

annPopTreatments <- yearDf(popTreatments, "treatments", pg$years,
                           pg$npops, pg$timestep)

totalTreatments <- popTreatments %>%
  group_by(year) %>%
  summarise(treatments = sum(treatments))

annTotalTreatments <- yearDf(totalTreatments, "treatments", pg$years,
                             1, pg$timestep)

totalTreatmentPlot <- ggplot(data = annTotalTreatments, 
    aes(x = year, y = treatments)) +
  geom_line(colour = "blue") +
  xlab("Year") + ylab("Number initiated treatment") +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  plotOpts

popTreatmentPlot <- ggplot(data = annPopTreatments, 
  aes(x = year, y = treatments, group = age_group)) + 
  geom_line(aes(color = age_group)) + 
  xlab("year") + ylab("Number initiated treatment") +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  scale_colour_brewer(name = "Age Group", palette = "Set1",
                      labels = c("Age < 4", "Age 5 to 14", "Age 15 to 44",
                                "Age > 45")) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  plotOpts + theme(legend.position = "right")

# HBV deaths -------------------------------------------------------------
popDeaths <- as.data.frame(t(bestResults$newHBVdeaths)) %>%
  mutate(year = pg$pts) %>%
  select(year, everything()) %>%
  gather("age_group", "deaths", 2:(pg$npops+1)) 

annPopDeaths <- yearDf(popDeaths, "deaths", pg$years,
                       pg$npops, pg$timestep)

totalDeaths <- popDeaths %>%
  group_by(year) %>%
  summarise(deaths = sum(deaths))

annTotalDeaths <- yearDf(totalDeaths, "deaths", pg$years,
                         1, pg$timestep)


totalDeathsPlot <- ggplot(data = annTotalDeaths, 
    aes(x = year, y = deaths)) +
  geom_line(colour = "blue") +
  xlab("Year") + ylab("Number of deaths") +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  plotOpts

popDeathsPlot <- ggplot(data = annPopDeaths, 
  aes(x = year, y = deaths, group = age_group)) + 
  geom_line(aes(color = age_group)) + 
  xlab("year") + ylab("Number of deaths") +
  scale_x_continuous(breaks = seq(startYear, endYear, 
                                  by = 5)) +
  coord_cartesian(xlim = c(startYear, endYear)) +
  scale_colour_brewer(name = "Age Group", palette = "Set1",
                      labels = c("Age < 4", "Age 5 to 14", "Age 15 to 44",
                                "Age > 45")) +
  plotOpts + theme(legend.position = "right")

# Vaccinations -----------------------------------------------------------


# Display plots (if required) --------------------------------------------

if (displayPlots) {
  totalPopPlot
  agePopPlot
  
  totalInfectedPlot
  totalPrevPlot
  popInfectedPlot
  popPrevPlot
  allPopsPlot
  
  totalNewInfectionsPlot
  popNewInfectionsPlot
  totalIncidencePlot
  popIncidencePlot
  
  totalTreatmentPlot
  popTreatmentPlot
  
  totalDeathsPlot
  popDeathsPlot
  
  # totalVaccinePlot
  # popVaccinePlot
}

# Save plots separately (if required) ------------------------------------
if (savePlots) {
  
  figureFolder <- file.path(projectFolder, project, "results")
  
  SaveFigure(figureFolder, "total_population", totalPopPlot)
  SaveFigure(figureFolder, "age_group_population", agePopPlot)
  
  SaveFigure(figureFolder, "total_infected", totalInfectedPlot)
  SaveFigure(figureFolder, "total_prevalence", totalPrevPlot)
  SaveFigure(figureFolder, "age_group_infected", popInfectedPlot)
  SaveFigure(figureFolder, "age_group_prevalence", popPrevPlot)
  SaveFigure(figureFolder, "all_pops_states", allPopsPlot)
  
  SaveFigure(figureFolder, "new_infections", totalNewInfectionsPlot)
  SaveFigure(figureFolder, "age_group_new_infections",
             popNewInfectionsPlot)
  SaveFigure(figureFolder, "total_incidence", totalIncidencePlot)
  SaveFigure(figureFolder, "age_group_incidence", popIncidencePlot)
  
  SaveFigure(figureFolder, "total_treatment", totalTreatmentPlot)
  SaveFigure(figureFolder, "age_group_treatment", popTreatmentPlot)
  
  SaveFigure(figureFolder, "total_deaths", totalDeathsPlot)
  SaveFigure(figureFolder, "age_group_deaths", popDeathsPlot)
  
  # Vaccination
}
```

## Summary Figures

### Total population size

**Figure 1** - Total population size over time.

```{r Insert figure 1, include = TRUE}
totalPopPlot
```

**Figure 2** - Population size by age group over time.

```{r Insert figure 2, include = TRUE}
agePopPlot
```

### Prevalence

**Figure 3** - Total number of people infected with HBV over time.

```{r Insert figure 3, include = TRUE}
totalInfectedPlot
```

**Figure 4** - Overall population prevalence over time.

```{r Insert figure 4, include = TRUE}
totalPrevPlot
```

**Figure 5** - Number of people infected with HBV over time by age group.

```{r Insert figure 5, include = TRUE}
popInfectedPlot
```

**Figure 6** - HBV prevalence by age group over time.

```{r Insert figure 6, include = TRUE}
popPrevPlot
```


**Figure 7** - Number of people in each stage of infection by age_group.

```{r Insert figure 7, include = TRUE}
allPopsPlot
```


### New infections and incidence

**Figure 8** - Total number of new HBV infections.

```{r Insert figure 8, include = TRUE}
totalNewInfectionsPlot
```

**Figure 9** - Number of new HBV infections by age group.

```{r Insert figure 9, include = TRUE}
popNewInfectionsPlot
```

**Figure 10** - Overall incidence per 100,000 people.

```{r Insert figure 10, include = TRUE}
totalIncidencePlot
```

**Figure 11** - Incidence per 100,000 people by age group.

```{r Insert figure 11, include = TRUE}
popIncidencePlot
```

### HBV Treatment

**Figure 12** - Total number of people initiating treatment per year.

```{r Insert figure 12, include = TRUE}
totalTreatmentPlot
```

**Figure 13** - Number of people initiating treatment per year by age
group.

```{r Insert figure 13, include = TRUE}
popTreatmentPlot
```

### Deaths

**Figure 14** - Total number of deaths per year.

```{r Insert figure 14, include = TRUE}
totalDeathsPlot
```

**Figure 15** - Number of deaths per year by age group.

```{r Insert figure 15, include = TRUE}
popDeathsPlot




```

### Vaccination



