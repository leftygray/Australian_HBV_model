---
title: "Australia HBV Model Summary Results"
author: "Richard T. Gray"
date: Latest version - `r format(Sys.Date(), format="%B %d %Y")`
output: 
  word_document:
    pandoc_args: --output="docs/Summary_results.docx"
    reference_docx: docs/mystyles.docx
---

<!---This Rmarkdown scipt generates the summary figures and outputs from
the results generated using the ECDC HIV Modelling Tool. --->

```{r knitr_options, include=FALSE} 
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      include = FALSE) 
```

This document presents the summary results for the baseline scenario in
the Australian HBV model. 

```{r Initialize script}
# Clear workspace and plots
rm(list = ls()) 
graphics.off()

# Setup directories after setting working directory to source file 
# directory (so it is easy to move code around)
basePath <- getwd()
Rcode <- file.path(basePath, "code")
projectFolder <- file.path(basePath, "projects")

# Load useful libraries
source(file.path(Rcode, "LoadLibrary.R"))
source(file.path(Rcode, "DataLibraries.R"))
source(file.path(Rcode, "PlotOptions.R"))
LoadLibrary(cowplot)

# Wrapper function so we don't have to keep entering everything in
# ggsave. Plot defaults are put in the figure defaults
SaveFigure <- function(folder, filename, figure, 
                       format = ".png", height = 10, 
                       units = "cm", ...) {
  save_plot(file.path(folder, paste0(filename, format)), 
         figure, 
         base_height = height, units = units, ...)
}

```

```{r User sepcifications}
# Specify project to run
project <- "Australia_HBV_estimates-BM"

# Plotting options
displayPlots <- TRUE
savePlots <- TRUE

```

```{r Load project results}
# This loads all the project parameters and results including 
# bestResults

projectFile <- file.path(projectFolder, project, paste0(project, ".rda"))
load(projectFile)
```

```{r Generate plots}

# Population sizes ------------------------------------------------------

# First convert results population sizes into a massize data frame
popSizes <- as.data.frame.table(bestResults$allPops)
colnames(popSizes) <- c("age_group", "state", "time_step", "popsize") 
popSizes$time_step <- as.numeric(popSizes$time_step)

popSizes <- popSizes %>% # add pts as well
  mutate(year = pg$start_year + (time_step-1) * pg$timestep) 

totalPop <- popSizes %>%
  group_by(year) %>%
  summarise(totalpop = sum(popsize)) 

totalPopPlot <- ggplot(data = totalPop, aes(x = year, y = totalpop)) +
  geom_line(colour = "blue") +
  xlab("Year") + ylab("Population size") +
  scale_x_continuous(breaks = seq(pg$start_year, pg$end_year +1, 
                                  by = 20)) +
  plotOpts

popSizesAge <- popSizes %>%
  group_by(year, age_group) %>%
  summarise(totalpop = sum(popsize)) %>%
  ungroup() %>%
  arrange(age_group)

# Plot of population size in every group
plotAgePops <- popSizesAge
plotAgePops$age_group <- factor(plotAgePops$age_group)
# rename levels for plotting
levels(plotAgePops$age_group) <- c("Age < 4", "Age 5 to 14", 
                                   "Age 15 to 44", "Age > 45") 

agePopPlot <- ggplot(data = plotAgePops, 
                     aes(x = year, y = totalpop, group = age_group)) +
  geom_line(colour = "blue") +
  facet_wrap(~age_group, ncol = 2, scales = "free_x") + 
  scale_x_continuous(breaks = seq(pg$start_year, pg$end_year +1, 
                                  by = 50)) +
  xlab("Year") + ylab("Population size") +
  plotOpts + theme(panel.margin = unit(2, "lines"))

# Population prevalence --------------------------------------------------

# Data frame for overall number of people infected by age 
prevSizes <-  popSizes %>%
  group_by(year, age_group) %>%
  filter(state != c("s", "cl", "i")) %>% 
  summarise(infectpop = sum(popsize)) %>%
  ungroup() %>%
  arrange(age_group) %>%
  mutate(popsize = popSizesAge$totalpop,
    prevalence = infectpop / popSizesAge$totalpop)

# Plot of total number of people infected
totalPrev <- prevSizes %>%
  group_by(year) %>%
  summarise(totalprev = sum(prevalence)) 

totalPrevPlot <- ggplot(data = totalPrev, aes(x = year, y = totalprev)) +
  geom_line(colour = "blue") +
  xlab("Year") + ylab("Population size") +
  scale_x_continuous(breaks = seq(pg$start_year, pg$end_year +1, 
                                  by = 20)) +
  plotOpts

# Plot of prevalence in every group

# First sort out level names for plotting
plotPrevPops <- prevSizes
plotPrevPops$age_group <- factor(prevSizes$age_group)
levels(plotPrevPops$age_group) <- c("Age < 4", "Age 5 to 14", 
                                   "Age 15 to 44", "Age > 45") 

# Creat plot
infectPopPlot <- ggplot(data = plotPrevPops, 
                     aes(x = year, y = infectpop, group = age_group)) +
  geom_line(colour = "blue") +
  facet_wrap(~age_group, ncol = 2, scales = "free_x") + 
  scale_x_continuous(breaks = seq(pg$start_year, pg$end_year +1, 
                                  by = 50)) +
  xlab("Year") + ylab("Population size") +
  plotOpts + theme(panel.margin = unit(2, "lines"))

# Plot of population size in every group
# Essentially prevalence by age and state
plotPops <- popSizes
plotPops$age_group <- factor(plotPops$age_group)
levels(plotPops$age_group) <- c("Age < 4", "Age 5 to 14", "Age 15 to 44",
                                "Age > 45") # rename levels for plotting

allPopsPlot <- ggplot(data = plotPops, 
                      aes(x = year, y = popsize, group = state)) +
  facet_wrap(~age_group, ncol = 2, scales = "free_x") +
  geom_line(aes(colour = state)) +
  scale_x_continuous(breaks = seq(pg$start_year, pg$end_year +1, 
                                  by = 50)) +
  scale_colour_brewer(name = "Infection state", palette = "Set1",
                      labels = c("Susceptible", "Acute", "Chronic",
                                 "Cleared", "Immune")) +
  xlab("Year") + ylab("Population size") +
  plotOpts + theme(legend.position = "right") + 
  theme(panel.margin = unit(2, "lines"))




# New infections and incidence -------------------------------------------
totalInfect <- infectSizes %>%
  group_by(year) %>%
  summarise(totalinfect = sum(infectpop)) 

totalInfectPlot <- ggplot(data = totalInfect, 
                          aes(x = year, y = totalinfect)) +
  geom_line(colour = "blue") +
  xlab("Year") + ylab("Population size") +
  scale_x_continuous(breaks = seq(pg$start_year, pg$end_year +1, 
                                  by = 20)) +
  plotOpts

newInfections <- as.data.frame(t(bestResults$newInfections)) %>%
  mutate(year = pg$pts) %>%
  select(year, everything()) %>%
  gather("age_group", "infections", 2:(pg$npops+1)) %>%
  mutate(incidence = infections / popSizesAge$totalpop)

# newInfectionsPlot
newInfectionsPlot <- ggplot(data = newInfections, 
    aes(x = year, y = infections, group= age_group)) +
  geom_line(aes(color = age_group)) + 
  xlab("Year") + ylab("New infections") +
  scale_x_continuous(breaks = seq(pg$start_year, pg$end_year +1, 
                                  by = 20)) +
  scale_colour_brewer(name = "Age Group", palette = "Set1",
                      labels = c("Age < 4", "Age 5 to 14", "Age 15 to 44",
                                "Age > 45")) + 
  plotOpts + theme(legend.position = "right")

#Incidence plot
incidencePlot <- ggplot(data = newInfections, 
  aes(x = year, y = incidence * 1e5, group = age_group)) + 
  geom_line(aes(color = age_group)) + 
  xlab("Year") + ylab("Incidence per 100,000") +
  scale_x_continuous(breaks = seq(pg$start_year, pg$end_year +1, 
                                  by = 20)) +
  scale_colour_brewer(name = "Age Group", palette = "Set1",
                      labels = c("Age < 4", "Age 5 to 14", "Age 15 to 44",
                                "Age > 45")) +
  plotOpts + theme(legend.position = "right")
  
# Treatment --------------------------------------------------------------
treatments <- as.data.frame(t(bestResults$newTreatments)) %>%
  mutate(year = pg$pts) %>%
  select(year, everything()) %>%
  gather("age_group", "treatments", 2:(pg$npops+1)) 

treatmentsPlot <- ggplot(data = treatments, 
  aes(x = year, y = treatments, group = age_group)) + 
  geom_line(aes(color = age_group)) + 
  xlab("year") + ylab("Treatments") +
  scale_x_continuous(breaks = seq(pg$start_year, pg$end_year +1, 
                                  by = 20)) +
  scale_colour_brewer(name = "Age Group", palette = "Set1",
                      labels = c("Age < 4", "Age 5 to 14", "Age 15 to 44",
                                "Age > 45")) +
  plotOpts + theme(legend.position = "right")

# HBV deaths -------------------------------------------------------------
deaths <- as.data.frame(t(bestResults$newHBVdeaths)) %>%
  mutate(year = pg$pts) %>%
  select(year, everything()) %>%
  gather("age_group", "treatments", 2:(pg$npops+1)) 

deathsPlot <- ggplot(data = deaths, 
  aes(x = year, y = treatments, group = age_group)) + 
  geom_line(aes(color = age_group)) + 
  xlab("year") + ylab("Deaths") +
  scale_x_continuous(breaks = seq(pg$start_year, pg$end_year +1, 
                                  by = 20)) +
  scale_colour_brewer(name = "Age Group", palette = "Set1",
                      labels = c("Age < 4", "Age 5 to 14", "Age 15 to 44",
                                "Age > 45")) +
  plotOpts + theme(legend.position = "right")


# Display plots (if required) --------------------------------------------

if (displayPlots) {
  totalPopPlot
  agePopPlot
  newInfectionsPlot
  incidencePlot
  allPopsPlot
}

# Save plots separately (if required) ------------------------------------
if (savePlots) {
  
  figureFolder <- file.path(projectFolder, project, "results")
  
  SaveFigure(figureFolder, "total_population", totalPopPlot)
  SaveFigure(figureFolder, "age_group_population", agePopPlot)
  SaveFigure(figureFolder, "new_infections", newInfectionsPlot)
  SaveFigure(figureFolder, "incidence", incidencePlot)
  SaveFigure(figureFolder, "all_pops_states", allPopsPlot)
}
```

## Summary Figures

### Total population size

**Figure 1** - Total population size over time.

```{r Insert figure 1, include = TRUE}
totalPopPlot
```

**Figure 2** - Population size by age group over time.

```{r Insert figure 2, include = TRUE}
agePopPlot
```


### New infections and incidence

**Figure 3** - New infections by age group.

```{r Insert figure 3, include = TRUE}
newInfectionsPlot
```

**Figure 4** - Incidence per 100,000 people by age group.

```{r Insert figure 4, include = TRUE}
incidencePlot
```

### Prevalence

**Figure 5** - Number of people in each stage of infection by age_group.

```{r Insert figure 5, include = TRUE}
allPopsPlot
```



